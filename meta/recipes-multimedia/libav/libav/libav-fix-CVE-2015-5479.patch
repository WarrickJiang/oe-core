From: Luca Barbato <lu_zero@gentoo.org>
Subject: [PATCH] h263: Always check both dimensions

Upstream-Status: Backport
https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-5479

CC: libav-stable@libav.org
Found-By: ago@gentoo.org

Signed-off-by: Zhixiong Chi <zhixiong.chi@windriver.com>
Index: libav-9.18/libavcodec/ituh263dec.c
===================================================================
--- libav-9.18.orig/libavcodec/ituh263dec.c	2015-03-09 10:28:31.000000000 +0800
+++ libav-9.18/libavcodec/ituh263dec.c	2016-05-13 11:08:29.805312947 +0800
@@ -30,6 +30,7 @@
 //#define DEBUG
 #include <limits.h>
 
+#include "libavutil/imgutils.h"
 #include "libavutil/mathematics.h"
 #include "dsputil.h"
 #include "avcodec.h"
@@ -868,7 +869,7 @@
 /* most is hardcoded. should extend to handle all h263 streams */
 int ff_h263_decode_picture_header(MpegEncContext *s)
 {
-    int format, width, height, i;
+    int format, width, height, i, ret;
     uint32_t startcode;
 
     align_get_bits(&s->gb);
@@ -920,8 +921,6 @@
         /* H.263v1 */
         width = ff_h263_format[format][0];
         height = ff_h263_format[format][1];
-        if (!width)
-            return -1;
 
         s->pict_type = AV_PICTURE_TYPE_I + get_bits1(&s->gb);
 
@@ -1074,6 +1073,9 @@
         s->qscale = get_bits(&s->gb, 5);
     }
 
+    if ((ret = av_image_check_size(s->width, s->height, 0, s)) < 0)
+        return ret;
+
     s->mb_width = (s->width  + 15) / 16;
     s->mb_height = (s->height  + 15) / 16;
     s->mb_num = s->mb_width * s->mb_height;
