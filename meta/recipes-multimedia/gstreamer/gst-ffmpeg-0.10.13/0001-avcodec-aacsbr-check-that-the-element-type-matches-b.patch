From 79a98294da6cd85f8c86b34764c5e0c43b09eea3 Mon Sep 17 00:00:00 2001
From: Michael Niedermayer <michaelni@gmx.at>
Date: Wed, 1 Jul 2015 02:05:43 +0200
Subject: [PATCH] avcodec/aacsbr: check that the element type matches before
 applying SBR

Fixes out of array access
Fixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux

Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
---
 libavcodec/aacsbr.c |    8 ++++++++
 libavcodec/sbr.h    |    1 +
 2 files changed, 9 insertions(+)

diff --git a/gst-libs/ext/libav/libavcodec/aacsbr.c b/gst-libs/ext/libav/libavcodec/aacsbr.c
index 7e98834..ca6dad7 100644
--- a/gst-libs/ext/libav/libavcodec/aacsbr.c
+++ b/gst-libs/ext/libav/libavcodec/aacsbr.c
@@ -990,6 +990,8 @@ static unsigned int read_sbr_data(AACContext *ac, SpectralBandReplication *sbr,
 {
     unsigned int cnt = get_bits_count(gb);
 
+    sbr->id_aac = id_aac;
+
     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {
         if (read_sbr_single_channel_element(ac, sbr, gb)) {
             sbr->start = 0;
@@ -1717,6 +1719,12 @@ void ff_sbr_apply(AACContext *ac, SpectralBandReplication *sbr, int id_aac,
     int ch;
     int nch = (id_aac == TYPE_CPE) ? 2 : 1;
 
+    if (id_aac != sbr->id_aac) {
+        av_log(ac->avctx, AV_LOG_ERROR,
+            "element type mismatch %d != %d\n", id_aac, sbr->id_aac);
+        sbr_turnoff(sbr);
+    }
+
     if (sbr->start) {
         sbr_dequant(sbr, id_aac);
     }
diff --git a/gst-libs/ext/libav/libavcodec/sbr.h b/gst-libs/ext/libav/libavcodec/sbr.h
index e28fccd..ff00acb 100644
--- a/gst-libs/ext/libav/libavcodec/sbr.h
+++ b/gst-libs/ext/libav/libavcodec/sbr.h
@@ -112,6 +112,7 @@ typedef struct {
 typedef struct {
     int                sample_rate;
     int                start;
+    int                id_aac;
     int                reset;
     SpectrumParameters spectrum_params;
     int                bs_amp_res_header;
-- 
1.7.9.5

