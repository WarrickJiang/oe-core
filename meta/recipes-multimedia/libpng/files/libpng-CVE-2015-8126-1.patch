libpng: CVE-2015-8126 1

the patch comes from:
https://bugzilla.redhat.com/show_bug.cgi?id=1281756
https://github.com/glennrp/libpng/commit/81f44665cce4cb1373f049a76f3904e981b7a766

[libpng16] Reject attempt to write over-length PLTE chunk

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 pngwutil.c |    7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/pngwutil.c b/pngwutil.c
index 49e6a2d..0f0640a 100644
--- a/pngwutil.c
+++ b/pngwutil.c
@@ -919,17 +919,20 @@ void /* PRIVATE */
 png_write_PLTE(png_structrp png_ptr, png_const_colorp palette,
     png_uint_32 num_pal)
 {
-   png_uint_32 i;
+   png_uint_32 max_num_pal, i;
    png_const_colorp pal_ptr;
    png_byte buf[3];
 
    png_debug(1, "in png_write_PLTE");
 
+   max_num_pal = (png_ptr->color_type == PNG_COLOR_TYPE_PALETTE) ?
+      (1 << png_ptr->bit_depth) : PNG_MAX_PALETTE_LENGTH;
+
    if ((
 #ifdef PNG_MNG_FEATURES_SUPPORTED
        !(png_ptr->mng_features_permitted & PNG_FLAG_MNG_EMPTY_PLTE) &&
 #endif
-       num_pal == 0) || num_pal > 256)
+       num_pal == 0) || num_pal > max_num_pal)
    {
       if (png_ptr->color_type == PNG_COLOR_TYPE_PALETTE)
       {
-- 
1.7.9.5

