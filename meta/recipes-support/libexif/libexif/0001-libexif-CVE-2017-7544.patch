From 7fd07cb04ee696c1995be1ead6bd4ea10ae91b59 Mon Sep 17 00:00:00 2001
From: Haiqing Bai <Haiqing.Bai@windriver.com>
Date: Wed, 8 Nov 2017 02:49:03 +0000
Subject: [PATCH] Heap Buffer Overflow due to a programming mistake

https://sourceforge.net/p/libexif/bugs/_discuss/thread/fc394c4b/489a/attachment/xx.pat

One heap-based out-of-bounds read vulnerabiltiy exists in libexif-0.6.21/20.
When saving the data of an entry tagged with EXIF_TAG_MAKER_NOTE to a buffer
and copying the data of the exif entry, there is a mismatch between the computed
read size of the entry data and the size of the allocated entry data.
The vulnerability can cause Denial-of-Service, even Information Disclosure
(disclosing some critical heap chunk metadata, even other applications private data)

Upstream-Status: Backport
CVE:CVE-2017-7544

Author: Marcus Meissner
Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 libexif/exif-data.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/libexif/exif-data.c b/libexif/exif-data.c
index 67df4db..e05607f 100644
--- a/libexif/exif-data.c
+++ b/libexif/exif-data.c
@@ -255,6 +255,12 @@ exif_data_save_data_entry (ExifData *data, ExifEntry *e,
 			exif_mnote_data_set_offset (data->priv->md, *ds - 6);
 			exif_mnote_data_save (data->priv->md, &e->data, &e->size);
 			e->components = e->size;
+			if (exif_format_get_size (e->format) != 1) {
+				/* e->format is taken from input code,
+				* but we need to make sure it is a 1 byte
+				* entity due to the multiplication below. */
+				e->format = EXIF_FORMAT_UNDEFINED;
+			}
 		}
 	}
 
-- 
2.5.0

