r1571 | ph10 | 2015-06-24 00:34:53

Fix buffer overflow for forward reference within backward assertion with excess 
closing parenthesis. Bugzilla 1651.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1570)
+++ b/pcre_compile.c	(revision 1571)
@@ -9449,7 +9449,7 @@
 exceptional ones forgo this. We scan the pattern to check that they are fixed
 length, and set their lengths. */
 
-if (cd->check_lookbehind)
+if (errorcode == 0 && cd->check_lookbehind)
   {
   pcre_uchar *cc = (pcre_uchar *)codestart;
 
Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1570)
+++ b/ChangeLog	(revision 1571)
@@ -22,6 +22,10 @@ ChangeLog for PCRE
 10. There was a buffer overflow if pcre_exec() was called with an ovector of 
     size 1. This bug was found by american fuzzy lop.
 
+18. A pattern with an unmatched closing parenthesis that contained a backward 
+    assertion which itself contained a forward reference caused buffer 
+    overflow. And example pattern is: /(?=di(?<=(?1))|(?=(.))))/.
+
 Version 8.37 28-April-2015
 --------------------------
 
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1570)
+++ b/testdata/testoutput2	(revision 1571)
@@ -14486,4 +14486,7 @@
         End
 ------------------------------------------------------------------
 
+/(?=di(?<=(?1))|(?=(.))))/
+Failed: unmatched parentheses at offset 23
+
 /-- End of testinput2 --/
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1570)
+++ b/testdata/testinput2	(revision 1571)
@@ -4180,4 +4180,6 @@
 
 /^(?:(?(1)x|)+)+$()/BZ
 
+/(?=di(?<=(?1))|(?=(.))))/
+
 /-- End of testinput2 --/
