r1557 | ph10 | 2015-05-09 00:39:40

Fix buffer overflow for repeated conditional when referencing a duplicate name.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1556)
+++ b/pcre_compile.c	(revision 1557)
@@ -6773,7 +6773,7 @@
             ptr++;
             }
           namelen = (int)(ptr - name);
-          if (lengthptr != NULL) *lengthptr += IMM2_SIZE;
+          if (lengthptr != NULL) skipbytes += IMM2_SIZE;
           }
 
         /* Check the terminator */
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1556)
+++ b/testdata/testoutput2	(revision 1557)
@@ -14448,4 +14448,10 @@
 /\V\x85\9*+((?2)\3++()2)*:2/
 Failed: reference to non-existent subpattern at offset 26
 
+/(((?(R)){0,2}) (?''((?'R')((?'R')))))/J
+
+/(((?(X)){0,2}) (?''((?'X')((?'X')))))/J
+
+/(((?(R)){0,2}) (?''((?'X')((?'R')))))/
+
 /-- End of testinput2 --/
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1556)
+++ b/testdata/testinput2	(revision 1557)
@@ -4160,4 +4160,10 @@
 
 /\V\x85\9*+((?2)\3++()2)*:2/
 
+/(((?(R)){0,2}) (?''((?'R')((?'R')))))/J
+
+/(((?(X)){0,2}) (?''((?'X')((?'X')))))/J
+
+/(((?(R)){0,2}) (?''((?'X')((?'R')))))/
+
 /-- End of testinput2 --/
Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1556)
+++ b/ChangeLog	(revision 1557)
@@ -1,6 +1,10 @@
 ChangeLog for PCRE
 ------------------
     
+3.  A repeated conditional group whose condition was a reference by name caused
+    a buffer overflow if there was more than one group with the given name.
+    This bug was discovered by the LLVM fuzzer.
+    
 10. There was a buffer overflow if pcre_exec() was called with an ovector of 
     size 1. This bug was found by american fuzzy lop.
 
