r1589 | ph10 | 2015-08-10 22:19:06

Add missing integer overflow checks.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1588)
+++ b/testdata/testoutput2	(revision 1589)
@@ -14543,4 +14543,10 @@
     01
 No match
 
+/((?(R8000000000)))/ 
+Failed: number is too big at offset 16
+
+/(?(8000000000/
+Failed: number is too big at offset 13
+
 /-- End of testinput2 --/
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1588)
+++ b/testdata/testinput2	(revision 1589)
@@ -4199,4 +4199,8 @@
 /0(?0)|(1)(*THEN)(*SKIP:0)(*FAIL)/
     01
 
+/((?(R8000000000)))/ 
+
+/(?(8000000000/
+
 /-- End of testinput2 --/
Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1588)
+++ b/pcre_compile.c	(revision 1589)
@@ -6769,6 +6769,12 @@
           {
           while (IS_DIGIT(*ptr))
             {
+            if (recno > INT_MAX / 10 - 1)  /* Integer overflow */              
+              {                                                             
+              while (IS_DIGIT(*ptr)) ptr++;                                 
+              *errorcodeptr = ERR61;                                        
+              goto FAILED; 
+              }
             recno = recno * 10 + (int)(*ptr - CHAR_0);
             ptr++;
             }
@@ -6903,6 +6909,11 @@
               *errorcodeptr = ERR15;
               goto FAILED;
               }
+            if (recno > INT_MAX / 10 - 1)   /* Integer overflow */          
+              {                                                                
+              *errorcodeptr = ERR61;                                        
+              goto FAILED;                                
+              }   
             recno = recno * 10 + name[i] - CHAR_0;
             }
           if (recno == 0) recno = RREF_ANY;
