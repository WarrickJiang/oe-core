Fix compiler crash/misbehaviour for zero-repeated groups that include a
recursive back reference.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1494)
+++ b/pcre_compile.c	(revision 1495)
@@ -8244,12 +8244,16 @@ for (;;)
 
     /* If it was a capturing subpattern, check to see if it contained any
     recursive back references. If so, we must wrap it in atomic brackets.
-    In any event, remove the block from the chain. */
+    Because we are moving code along, we must ensure that any pending recursive
+    references are updated. In any event, remove the block from the chain. */
 
     if (capnumber > 0)
       {
       if (cd->open_caps->flag)
         {
+        *code = OP_END;
+        adjust_recurse(start_bracket, 1 + LINK_SIZE,
+          (options & PCRE_UTF8) != 0, cd, cd->hwm);
         memmove(start_bracket + 1 + LINK_SIZE, start_bracket,
           IN_UCHARS(code - start_bracket));
         *start_bracket = OP_ONCE;
Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1494)
+++ b/ChangeLog	(revision 1495)
@@ -1,5 +1,10 @@
 ChangeLog for PCRE
 ------------------
+    
+19. Incorrect code was compiled if a group that contained an internal recursive 
+    back reference was optional (had quantifier with a minimum of zero). This
+    example compiled incorrect code: /(((a\2)|(a*)\g<-1>))*/ and other examples 
+    caused segmentation faults because of stack overflows at compile time. 
 
 Version 8.35 04-April-2014
 --------------------------
Index: testdata/testoutput11-32
===================================================================
--- a/testdata/testoutput11-32	(revision 1494)
+++ b/testdata/testoutput11-32	(revision 1495)
@@ -709,4 +709,28 @@
  62     End
 ------------------------------------------------------------------
 
+/(((a\2)|(a*)\g<-1>))*a?/B
+------------------------------------------------------------------
+  0  39 Bra
+  2     Brazero
+  3  32 SCBra 1
+  6  27 Once
+  8  12 CBra 2
+ 11   7 CBra 3
+ 14     a
+ 16     \2
+ 18   7 Ket
+ 20  11 Alt
+ 22   5 CBra 4
+ 25     a*
+ 27   5 Ket
+ 29  22 Recurse
+ 31  23 Ket
+ 33  27 Ket
+ 35  32 KetRmax
+ 37     a?+
+ 39  39 Ket
+ 41     End
+------------------------------------------------------------------
+
 /-- End of testinput11 --/
Index: testdata/testoutput11-8
===================================================================
--- a/testdata/testoutput11-8	(revision 1494)
+++ b/testdata/testoutput11-8	(revision 1495)
@@ -709,4 +709,28 @@
  76     End
 ------------------------------------------------------------------
 
+/(((a\2)|(a*)\g<-1>))*a?/B
+------------------------------------------------------------------
+  0  57 Bra
+  3     Brazero
+  4  48 SCBra 1
+  9  40 Once
+ 12  18 CBra 2
+ 17  10 CBra 3
+ 22     a
+ 24     \2
+ 27  10 Ket
+ 30  16 Alt
+ 33   7 CBra 4
+ 38     a*
+ 40   7 Ket
+ 43  33 Recurse
+ 46  34 Ket
+ 49  40 Ket
+ 52  48 KetRmax
+ 55     a?+
+ 57  57 Ket
+ 60     End
+------------------------------------------------------------------
+
 /-- End of testinput11 --/
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1494)
+++ b/testdata/testinput2	(revision 1495)
@@ -4035,6 +4035,8 @@
 
 /(?(R&6yh)abc)/
 
+/(((a\2)|(a*)\g<-1>))*a?/BZ
+
 /-- Test the ugly "start or end of word" compatibility syntax --/
 
 /[[:<:]]red[[:>:]]/BZ
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1494)
+++ b/testdata/testoutput2	(revision 1495)
@@ -14093,6 +14093,30 @@
 /(?(R&6yh)abc)/
 Failed: group name must start with a non-digit at offset 5
 
+/(((a\2)|(a*)\g<-1>))*a?/BZ
+------------------------------------------------------------------
+        Bra
+        Brazero
+        SCBra 1
+        Once
+        CBra 2
+        CBra 3
+        a
+        \2
+        Ket
+        Alt
+        CBra 4
+        a*
+        Ket
+        Recurse
+        Ket
+        Ket
+        KetRmax
+        a?+
+        Ket
+        End
+------------------------------------------------------------------
+
 /-- Test the ugly "start or end of word" compatibility syntax --/
 
 /[[:<:]]red[[:>:]]/BZ
Index: testdata/testoutput11-16
===================================================================
--- a/testdata/testoutput11-16	(revision 1494)
+++ b/testdata/testoutput11-16	(revision 1495)
@@ -709,4 +709,28 @@
  62     End
 ------------------------------------------------------------------
 
+/(((a\2)|(a*)\g<-1>))*a?/B
+------------------------------------------------------------------
+  0  39 Bra
+  2     Brazero
+  3  32 SCBra 1
+  6  27 Once
+  8  12 CBra 2
+ 11   7 CBra 3
+ 14     a
+ 16     \2
+ 18   7 Ket
+ 20  11 Alt
+ 22   5 CBra 4
+ 25     a*
+ 27   5 Ket
+ 29  22 Recurse
+ 31  23 Ket
+ 33  27 Ket
+ 35  32 KetRmax
+ 37     a?+
+ 39  39 Ket
+ 41     End
+------------------------------------------------------------------
+
 /-- End of testinput11 --/
Index: testdata/testinput11
===================================================================
--- a/testdata/testinput11	(revision 1494)
+++ b/testdata/testinput11	(revision 1495)
@@ -132,4 +132,6 @@
 
 /abc(d|e)(*THEN)x(123(*THEN)4|567(b|q)(*THEN)xx)/B
 
+/(((a\2)|(a*)\g<-1>))*a?/B
+
 /-- End of testinput11 --/
