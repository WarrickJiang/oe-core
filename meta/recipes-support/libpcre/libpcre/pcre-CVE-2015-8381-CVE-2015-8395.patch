r1594 | ph10 | 2015-08-22 00:08:33

Hack in yet other patch for a bug in size computation that is fixed "properly" 
in PCRE2.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1593)
+++ b/testdata/testinput2	(revision 1594)
@@ -4211,4 +4211,6 @@
 /((*MARK:A))++a(*SKIP:B)b/
     aacb
 
+/(?J:(?|(:(?|(?'R')(\z(?|(?'R')(\k'R')|((?'R')))k'R')|((?'R')))H'Ak'Rf)|s(?'R')))/
+
 /-- End of testinput2 --/
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1593)
+++ b/testdata/testoutput2	(revision 1594)
@@ -14561,4 +14561,6 @@
     aacb
 No match
 
+/(?J:(?|(:(?|(?'R')(\z(?|(?'R')(\k'R')|((?'R')))k'R')|((?'R')))H'Ak'Rf)|s(?'R')))/
+
 /-- End of testinput2 --/
Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1593)
+++ b/pcre_compile.c	(revision 1594)
@@ -7119,7 +7119,7 @@ for (;; ptr++)
           encountered. In that case, we allow yet more memory, just in case. 
           (Again, this is fixed "properly" in PCRE2. */
           
-          if (cd->dupgroups) *lengthptr += 2 + 2*LINK_SIZE;
+          if (cd->dupgroups) *lengthptr += 4 + 4*LINK_SIZE;
 
           /* Otherwise, check for recursion here. The name table does not exist
           in the first pass; instead we must scan the list of names encountered
@@ -9310,7 +9310,7 @@ if (errorcode == 0 && re->top_backref > re->top_bracket) errorcode = ERR15;
 /* Unless disabled, check whether single character iterators can be
 auto-possessified. The function overwrites the appropriate opcode values. */
 
-if ((options & PCRE_NO_AUTO_POSSESS) == 0)
+if (errorcode == 0 && (options & PCRE_NO_AUTO_POSSESS) == 0)
   auto_possessify((pcre_uchar *)codestart, utf, cd);
 
 /* If there were any lookbehind assertions that contained OP_RECURSE
@@ -9701,4 +9701,3 @@
 }
 
 /* End of pcre_compile.c */
-
