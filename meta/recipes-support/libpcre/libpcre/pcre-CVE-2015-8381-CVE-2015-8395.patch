r1594 | ph10 | 2015-08-22 00:08:33

Hack in yet other patch for a bug in size computation that is fixed "properly" 
in PCRE2.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1593)
+++ b/testdata/testinput2	(revision 1594)
@@ -4211,4 +4211,6 @@
 /((*MARK:A))++a(*SKIP:B)b/
     aacb
 
+/(?J:(?|(:(?|(?'R')(\z(?|(?'R')(\k'R')|((?'R')))k'R')|((?'R')))H'Ak'Rf)|s(?'R')))/
+
 /-- End of testinput2 --/
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1593)
+++ b/testdata/testoutput2	(revision 1594)
@@ -14561,4 +14561,6 @@
     aacb
 No match
 
+/(?J:(?|(:(?|(?'R')(\z(?|(?'R')(\k'R')|((?'R')))k'R')|((?'R')))H'Ak'Rf)|s(?'R')))/
+
 /-- End of testinput2 --/
Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1593)
+++ b/pcre_compile.c	(revision 1594)
@@ -7238,7 +7238,7 @@
           encountered. In that case, we allow yet more memory, just in case. 
           (Again, this is fixed "properly" in PCRE2. */
           
-          if (cd->dupgroups) *lengthptr += 2 + 2*LINK_SIZE;
+          if (cd->dupgroups) *lengthptr += 4 + 4*LINK_SIZE;
 
           /* Otherwise, check for recursion here. The name table does not exist
           in the first pass; instead we must scan the list of names encountered
@@ -9474,7 +9474,7 @@
 "const" attribute if the cast (pcre_uchar *)codestart is used directly in the
 function call. */
 
-if ((options & PCRE_NO_AUTO_POSSESS) == 0)
+if (errorcode == 0 && (options & PCRE_NO_AUTO_POSSESS) == 0)
   {
   pcre_uchar *temp = (pcre_uchar *)codestart;
   auto_possessify(temp, utf, cd);
@@ -9701,4 +9701,3 @@
 }
 
 /* End of pcre_compile.c */
-
Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1593)
+++ b/ChangeLog	(revision 1594)
@@ -59,6 +59,14 @@ development is happening in the PCRE2 10.xx series.
     (?(R<digits>). This omission was discovered by Karl Skomski with the LLVM
     fuzzer.
 
+35. Match limit check added to JIT recursion. This issue was found by Karl
+    Skomski with a custom LLVM fuzzer.
+    
+36. Yet another case similar to 27 above has been circumvented by an 
+    unconditional allocation of extra memory. This issue is fixed "properly" in 
+    PCRE2 by refactoring the way references are handled. Wen Guanxing 
+    from Venustech ADLAB discovered this bug. 
+
 Version 8.37 28-April-2015
 --------------------------
 
