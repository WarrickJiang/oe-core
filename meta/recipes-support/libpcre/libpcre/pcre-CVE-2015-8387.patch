r1563 | ph10 | 2015-06-09 01:55:54

Add integer overflow check to (?n) code.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1562)
+++ b/ChangeLog	(revision 1563)
@@ -16,6 +16,8 @@ ChangeLog for PCRE
     
 6.  A lookbehind assertion within a set of mutually recursive subpatterns could
     provoke a buffer overflow. This bug was discovered by the LLVM fuzzer.
+    
+8.  There was no check for integer overflow in subroutine calls such as (?123). 
 
 10. There was a buffer overflow if pcre_exec() was called with an ovector of 
     size 1. This bug was found by american fuzzy lop.
Index: pcre_compile.c
===================================================================
--- a/pcre_compile.c	(revision 1562)
+++ b/pcre_compile.c	(revision 1563)
@@ -7353,7 +7353,15 @@
 
           recno = 0;
           while(IS_DIGIT(*ptr))
+            {
+            if (recno > INT_MAX / 10 - 1) /* Integer overflow */            
+              {                                                             
+              while (IS_DIGIT(*ptr)) ptr++;                                 
+              *errorcodeptr = ERR61;                                        
+              goto FAILED;                                                  
+              }
             recno = recno * 10 + *ptr++ - CHAR_0;
+            } 
 
           if (*ptr != (pcre_uchar)terminator)
             {
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1562)
+++ b/testdata/testinput2	(revision 1563)
@@ -4173,4 +4173,6 @@
 
 "(?J:(?|(?'R')(\k'R')|((?'R'))))"
 
+/(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
+
 /-- End of testinput2 --/
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1562)
+++ b/testdata/testoutput2	(revision 1563)
@@ -14461,4 +14461,7 @@
 
 "(?J:(?|(?'R')(\k'R')|((?'R'))))"
 
+/(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
+Failed: number is too big at offset 32
+
 /-- End of testinput2 --/
