r1565 | ph10 | 2015-06-10 00:46:52

Fix overflow when ovector has size 1.

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

Index: pcre_exec.c
===================================================================
--- a/pcre_exec.c	(revision 1564)
+++ b/pcre_exec.c	(revision 1565)
@@ -6685,7 +6685,8 @@
   register int *iend = iptr - re->top_bracket;
   if (iend < md->offset_vector + 2) iend = md->offset_vector + 2;
   while (--iptr >= iend) *iptr = -1;
-  md->offset_vector[0] = md->offset_vector[1] = -1;
+  if (offsetcount > 0) md->offset_vector[0] = -1;
+  if (offsetcount > 1) md->offset_vector[1] = -1;
   }
 
 /* Set up the first character to match, if available. The first_char value is
Index: testdata/testoutput2
===================================================================
--- a/testdata/testoutput2	(revision 1564)
+++ b/testdata/testoutput2	(revision 1565)
@@ -14464,4 +14464,8 @@
 /(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
 Failed: number is too big at offset 32
 
+//
+\O1
+Matched, but too many substrings
+
 /-- End of testinput2 --/
Index: testdata/testinput2
===================================================================
--- a/testdata/testinput2	(revision 1564)
+++ b/testdata/testinput2	(revision 1565)
@@ -4175,4 +4175,7 @@
 
 /(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
 
+//
+\O1
+
 /-- End of testinput2 --/
Index: ChangeLog
===================================================================
--- a/ChangeLog	(revision 1564)
+++ b/ChangeLog	(revision 1565)
@@ -1,5 +1,8 @@
 ChangeLog for PCRE
 ------------------
+    
+10. There was a buffer overflow if pcre_exec() was called with an ovector of 
+    size 1. This bug was found by american fuzzy lop.
 
 Version 8.37 28-April-2015
 --------------------------
