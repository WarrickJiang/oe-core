From cf09dc031587b9d228f12cc3bb5cd9537ec7861e Mon Sep 17 00:00:00 2001
From: Francois Chagnon <francois.chagnon@jadedpixel.com>
Date: Tue, 10 Mar 2015 16:52:10 +0000
Subject: [PATCH] tentative fix for <!-- issue,

---
 HTMLparser.c | 22 +++++++++++++++-------
 1 file changed, 15 insertions(+), 7 deletions(-)

diff --git a/HTMLparser.c.old b/HTMLparser.c
index 2e646ad..945dbdf 100644
--- a/HTMLparser.c.old
+++ b/HTMLparser.c
@@ -3000,13 +3000,20 @@ htmlParseComment(htmlParserCtxtPtr ctxt) {
 	ctxt->instate = state;
 	return;
     }
+    if ((ctxt->input->end - ctxt->input->cur) < 3) {
+	ctxt->instate = XML_PARSER_EOF;
+	htmlParseErr(ctxt, XML_ERR_COMMENT_NOT_FINISHED, 
+		"Comment not terminated\n", NULL, NULL);
+	xmlFree(buf);
+	return;
+    }
     q = CUR_CHAR(ql);
     NEXTL(ql);
     r = CUR_CHAR(rl);
     NEXTL(rl);
     cur = CUR_CHAR(l);
     len = 0;
-    while (IS_CHAR(cur) &&
+    while (((ctxt->input->end - ctxt->input->cur) > 0) && IS_CHAR(cur) &&
            ((cur != '>') ||
 	    (r != '-') || (q != '-'))) {
 	if (len + 5 >= size) {
@@ -3036,7 +3043,7 @@ htmlParseComment(htmlParserCtxtPtr ctxt) {
 	}
     }
     buf[len] = 0;
-    if (!IS_CHAR(cur)) {
+    if (!(ctxt->input->end - ctxt->input->cur) || !IS_CHAR(cur)) {
 	htmlParseErr(ctxt, XML_ERR_COMMENT_NOT_FINISHED,
 	             "Comment not terminated \n<!--%.50s\n", buf, NULL);
 	xmlFree(buf);
@@ -3769,6 +3776,7 @@ htmlParseContent(htmlParserCtxtPtr ctxt) {
     depth = ctxt->nameNr;
     while (1) {
 	long cons = ctxt->nbChars;
+	long rem = ctxt->input->end - ctxt->input->cur;
 
         GROW;
 	/*
@@ -3805,7 +3813,7 @@ htmlParseContent(htmlParserCtxtPtr ctxt) {
 	    /*
 	     * Sometimes DOCTYPE arrives in the middle of the document
 	     */
-	    if ((CUR == '<') && (NXT(1) == '!') &&
+	    if ((rem >= 9) && (CUR == '<') && (NXT(1) == '!') &&
 		(UPP(2) == 'D') && (UPP(3) == 'O') &&
 		(UPP(4) == 'C') && (UPP(5) == 'T') &&
 		(UPP(6) == 'Y') && (UPP(7) == 'P') &&
@@ -3819,7 +3827,7 @@ htmlParseContent(htmlParserCtxtPtr ctxt) {
 	    /*
 	     * First case :  a comment
 	     */
-	    if ((CUR == '<') && (NXT(1) == '!') &&
+	    if ((rem >= 4) && (CUR == '<') && (NXT(1) == '!') &&
 		(NXT(2) == '-') && (NXT(3) == '-')) {
 		htmlParseComment(ctxt);
 	    }
@@ -3827,14 +3835,14 @@ htmlParseContent(htmlParserCtxtPtr ctxt) {
 	    /*
 	     * Second case : a Processing Instruction.
 	     */
-	    else if ((CUR == '<') && (NXT(1) == '?')) {
+	    else if ((rem >= 2) && (CUR == '<') && (NXT(1) == '?')) {
 		htmlParsePI(ctxt);
 	    }
 
 	    /*
 	     * Third case :  a sub-element.
 	     */
-	    else if (CUR == '<') {
+	    else if ((rem >= 1) && (CUR == '<')) {
 		htmlParseElement(ctxt);
 	    }
 
@@ -3842,7 +3850,7 @@ htmlParseContent(htmlParserCtxtPtr ctxt) {
 	     * Fourth case : a reference. If if has not been resolved,
 	     *    parsing returns it's Name, create the node 
 	     */
-	    else if (CUR == '&') {
+	    else if ((rem >= 1) && (CUR == '&')) {
 		htmlParseReference(ctxt);
 	    }
 
