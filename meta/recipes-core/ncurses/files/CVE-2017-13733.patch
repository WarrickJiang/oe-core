From 5c28d987f07bf311ccc1a04455e876d906202a12 Mon Sep 17 00:00:00 2001
From: Ovidiu Panait <ovidiu.panait@windriver.com>
Date: Mon, 12 Feb 2018 09:34:16 +0000
Subject: [PATCH] Import upstream patch 20170902

20170902
	+ amend change for endwin-state for better consistency with the older
	  logic (report/patch by Jeb Rosen, cf: 20170722).
	+ modify check in fmt_entry() to handle a cancelled reset string
	  (Debian #873746).  Make similar fixes in other parts of dump_entry.c
	  and tput.c

Upstream-Status: Backport
CVE: CVE-2017-13733

Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
---
 ncurses/tty/tty_update.c |  2 +-
 progs/dump_entry.c       | 21 +++++++++++----------
 progs/tput.c             |  2 +-
 3 files changed, 13 insertions(+), 12 deletions(-)

diff --git a/ncurses/tty/tty_update.c b/ncurses/tty/tty_update.c
index c08f853f..021c80e3 100644
--- a/ncurses/tty/tty_update.c
+++ b/ncurses/tty/tty_update.c
@@ -816,7 +816,7 @@ TINFO_DOUPDATE(NCURSES_SP_DCL0)
 	SP_PARM->_fifohold--;
 
 #if USE_SIZECHANGE
-    if ((SP_PARM->_endwin == ewRunning)
+    if ((SP_PARM->_endwin == ewSuspend)
 	|| _nc_handle_sigwinch(SP_PARM)) {
 	/*
 	 * This is a transparent extension:  XSI does not address it,
diff --git a/progs/dump_entry.c b/progs/dump_entry.c
index 3efe05f4..3b1fcb1e 100644
--- a/progs/dump_entry.c
+++ b/progs/dump_entry.c
@@ -39,7 +39,7 @@
 #include "termsort.c"		/* this C file is generated */
 #include <parametrized.h>	/* so is this */
 
-MODULE_ID("$Id: dump_entry.c,v 1.167 2017/07/15 21:22:01 tom Exp $")
+MODULE_ID("$Id: dump_entry.c,v 1.168 2017/09/02 21:01:54 tom Exp $")
 
 #define DISCARD(string) string = ABSENT_STRING
 #define PRINTF (void) printf
@@ -987,12 +987,12 @@ fmt_entry(TERMTYPE2 *tterm,
 #undef CUR
 #define CUR tterm->
     if (outform == F_TERMCAP) {
-	if (termcap_reset != ABSENT_STRING) {
-	    if (init_3string != ABSENT_STRING
+	if (VALID_STRING(termcap_reset)) {
+	    if (VALID_STRING(init_3string)
 		&& !strcmp(init_3string, termcap_reset))
 		DISCARD(init_3string);
 
-	    if (reset_2string != ABSENT_STRING
+	    if (VALID_STRING(reset_2string)
 		&& !strcmp(reset_2string, termcap_reset))
 		DISCARD(reset_2string);
 	}
@@ -1068,7 +1068,7 @@ fmt_entry(TERMTYPE2 *tterm,
 	buffer[0] = '\0';
 
 	if (predval != FAIL) {
-	    if (capability != ABSENT_STRING
+	    if (VALID_STRING(capability)
 		&& i + 1 > num_strings)
 		num_strings = i + 1;
 
@@ -1148,8 +1148,7 @@ fmt_entry(TERMTYPE2 *tterm,
 	    }
 	}
 	/* e.g., trimmed_sgr0 */
-	if (capability != ABSENT_STRING &&
-	    capability != CANCELLED_STRING &&
+	if (VALID_STRING(capability) &&
 	    capability != tterm->Strings[i])
 	    free(capability);
     }
@@ -1320,7 +1319,8 @@ kill_labels(TERMTYPE2 *tterm, int target)
 
     for (n = 0; n <= 10; ++n) {
 	_nc_SPRINTF(name, _nc_SLIMIT(sizeof(name)) "lf%d", n);
-	if ((cap = find_string(tterm, name)) != ABSENT_STRING
+	cap = find_string(tterm, name);
+	if (VALID_STRING(cap)
 	    && kill_string(tterm, cap)) {
 	    target -= (int) (strlen(cap) + 5);
 	    ++result;
@@ -1345,7 +1345,8 @@ kill_fkeys(TERMTYPE2 *tterm, int target)
 
     for (n = 60; n >= 0; --n) {
 	_nc_SPRINTF(name, _nc_SLIMIT(sizeof(name)) "kf%d", n);
-	if ((cap = find_string(tterm, name)) != ABSENT_STRING
+	cap = find_string(tterm, name);
+	if (VALID_STRING(cap)
 	    && kill_string(tterm, cap)) {
 	    target -= (int) (strlen(cap) + 5);
 	    ++result;
@@ -1367,7 +1368,7 @@ one_one_mapping(const char *mapping)
 {
     bool result = TRUE;
 
-    if (mapping != ABSENT_STRING) {
+    if (VALID_STRING(mapping)) {
 	int n = 0;
 	while (mapping[n] != '\0') {
 	    if (isLine(mapping[n]) &&
diff --git a/progs/tput.c b/progs/tput.c
index 5b43ca71..d532d0d1 100644
--- a/progs/tput.c
+++ b/progs/tput.c
@@ -196,7 +196,7 @@ tput_cmd(int fd, TTY * saved_settings, int argc, char *argv[])
 	}
 #endif
 	quit(4, "unknown terminfo capability '%s'", name);
-    } else if (s != ABSENT_STRING) {
+    } else if (VALID_STRING(s)) {
 	if (argc > 1) {
 	    int k;
 	    int ignored;
-- 
2.13.3

