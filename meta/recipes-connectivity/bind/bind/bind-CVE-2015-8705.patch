From c3130231590ef21251e2fad9a6c582d101f59894 Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Thu, 31 Dec 2015 22:17:37 +1100
Subject: [PATCH 2/2] bind: bug fix for CVE-2015-8705

commit 3e0c1603a835c678b07f1147909bf196988ee0d3 upstream
https://source.isc.org/git/bind9.git

4286. [security] render_ecs errors were mishandled when
printing out a OPT record resulting in a assertion
failure. (CVE-2015-8705) [RT #41397]

Upstream Status: Backport
CVE: CVE-2015-8705

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 lib/dns/message.c | 31 +++++++++++++++++++++----------
 1 file changed, 21 insertions(+), 10 deletions(-)

diff --git a/lib/dns/message.c b/lib/dns/message.c
index b4d0e60..7ff8d16 100644
--- a/lib/dns/message.c
+++ b/lib/dns/message.c
@@ -3230,23 +3230,23 @@ dns_message_sectiontotext(dns_message_t *msg, dns_section_t section,
 }
 
 static isc_result_t
-render_ecs(isc_buffer_t *optbuf, isc_buffer_t *target) {
+render_ecs(isc_buffer_t *ecsbuf, isc_buffer_t *target) {
 	int i;
 	char addr[16], addr_text[64];
 	isc_uint16_t family;
 	isc_uint8_t addrlen, addrbytes, scopelen;
 
-	INSIST(isc_buffer_remaininglength(optbuf) >= 4);
-	family = isc_buffer_getuint16(optbuf);
-	addrlen = isc_buffer_getuint8(optbuf);
-	scopelen = isc_buffer_getuint8(optbuf);
+	INSIST(isc_buffer_remaininglength(ecsbuf) >= 4);
+	family = isc_buffer_getuint16(ecsbuf);
+	addrlen = isc_buffer_getuint8(ecsbuf);
+	scopelen = isc_buffer_getuint8(ecsbuf);
 
 	addrbytes = (addrlen + 7) / 8;
-	INSIST(isc_buffer_remaininglength(optbuf) >= addrbytes);
+	INSIST(isc_buffer_remaininglength(ecsbuf) >= addrbytes);
 
 	memset(addr, 0, sizeof(addr));
 	for (i = 0; i < addrbytes; i ++)
-		addr[i] = isc_buffer_getuint8(optbuf);
+		addr[i] = isc_buffer_getuint8(ecsbuf);
 
 	if (family == 1)
 		inet_ntop(AF_INET, addr, addr_text, sizeof(addr_text));
@@ -3333,10 +3333,21 @@ dns_message_pseudosectiontotext(dns_message_t *msg,
 			} else if (optcode == DNS_OPT_SIT) {
 				ADD_STRING(target, "; SIT");
 			} else if (optcode == DNS_OPT_CLIENT_SUBNET) {
+				isc_buffer_t ecsbuf;
+
 				ADD_STRING(target, "; CLIENT-SUBNET: ");
-				render_ecs(&optbuf, target);
-				ADD_STRING(target, "\n");
-				continue;
+				isc_buffer_init(&ecsbuf,
+						isc_buffer_current(&optbuf),
+						optlen);
+				isc_buffer_add(&ecsbuf, optlen);
+				result = render_ecs(&ecsbuf, target);
+				if (result == ISC_R_NOSPACE)
+					return (result);
+				if (result == ISC_R_SUCCESS) {
+					isc_buffer_forward(&optbuf, optlen);
+					ADD_STRING(target, "\n");
+					continue;
+				}
 			} else if (optcode == DNS_OPT_EXPIRE) {
 				if (optlen == 4) {
 					isc_uint32_t secs;
-- 
1.9.1

