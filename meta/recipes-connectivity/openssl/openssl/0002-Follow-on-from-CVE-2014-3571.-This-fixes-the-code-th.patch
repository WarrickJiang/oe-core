From 45fe66b8ba026186aa5d8ef1e0e6010ea74d5c0b Mon Sep 17 00:00:00 2001
From: Matt Caswell <matt@openssl.org>
Date: Sat, 3 Jan 2015 00:54:35 +0000
Subject: [PATCH 2/2] Follow on from CVE-2014-3571. This fixes the code that
 was the original source of the crash due to p being
 NULL. Steve's fix prevents this situation from occuring
 - however this is by no means obvious by looking at the
 code for dtls1_get_record. This fix just makes things
 look a bit more sane.

(Upstream commit 45fe66b8ba026186aa5d8ef1e0e6010ea74d5c0b openSSL_1_0_1-stable)

Upstream-Status: Backport

Reviewed-by: Dr Steve Henson <steve@openssl.org>
Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 ssl/d1_pkt.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/ssl/d1_pkt.c b/ssl/d1_pkt.c
index d717260..73ce488 100644
--- a/ssl/d1_pkt.c
+++ b/ssl/d1_pkt.c
@@ -676,7 +676,8 @@ again:
 		 * would be dropped unnecessarily.
 		 */
 		if (!(s->d1->listen && rr->type == SSL3_RT_HANDSHAKE &&
-		    *p == SSL3_MT_CLIENT_HELLO) &&
+		    s->packet_length > DTLS1_RT_HEADER_LENGTH &&
+		    s->packet[DTLS1_RT_HEADER_LENGTH] == SSL3_MT_CLIENT_HELLO) &&
 		    !dtls1_record_replay_check(s, bitmap))
 			{
 			rr->length = 0;
-- 
1.7.9.5

