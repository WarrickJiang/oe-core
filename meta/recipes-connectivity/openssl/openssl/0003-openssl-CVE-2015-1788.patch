From 5dea9cd8353b44779939a5896fc40c4574b6fc05 Mon Sep 17 00:00:00 2001
From: Andy Polyakov <appro@openssl.org>
Date: Thu, 11 Jun 2015 00:18:01 +0200
Subject: [PATCH 3/7] openssl: CVE-2015-1788

Commit f61bbf8da532038ed0eae16a9a11771f3da22d30 upstream
https://github.com/openssl/openssl.git

bn/bn_gf2m.c: avoid infinite loop wich malformed ECParamters.

CVE-2015-1788

Reviewed-by: Matt Caswell <matt@openssl.org>
(cherry picked from commit 4924b37ee01f71ae19c94a8934b80eeb2f677932)
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 crypto/bn/bn_gf2m.c | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/crypto/bn/bn_gf2m.c b/crypto/bn/bn_gf2m.c
index 8a4dc20..6a9a437 100644
--- a/crypto/bn/bn_gf2m.c
+++ b/crypto/bn/bn_gf2m.c
@@ -568,9 +568,10 @@ int BN_GF2m_mod_inv(BIGNUM *r, const BIGNUM *a, const BIGNUM *p, BN_CTX *ctx)
 		}
 #else
 	{
-	int i,	ubits = BN_num_bits(u),
-		vbits = BN_num_bits(v),	/* v is copy of p */
-		top = p->top;
+	int i;
+	int ubits = BN_num_bits(u);
+	int vbits = BN_num_bits(v);	/* v is copy of p */
+	int top = p->top;
 	BN_ULONG *udp,*bdp,*vdp,*cdp;
 
 	bn_wexpand(u,top);	udp = u->d;
@@ -611,7 +612,13 @@ int BN_GF2m_mod_inv(BIGNUM *r, const BIGNUM *a, const BIGNUM *p, BN_CTX *ctx)
 			ubits--;
 			}
 
-		if (ubits<=BN_BITS2 && udp[0]==1) break;
+		if (ubits<=BN_BITS2)
+			{
+			if (udp[0]==0)	/* poly was reducible */
+				goto err;
+			if (udp[0] == 1)
+				break;
+			}
 
 		if (ubits<vbits)
 			{
-- 
1.8.5.2.233.g932f7e4

