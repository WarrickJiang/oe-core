From a9f83d439d3a69e950f84038b71caaa13b8316ce Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Tue, 1 Sep 2015 16:49:56 +0800
Subject: [PATCH 2/2] openssh: CVE-2015-6564

Upstream-Status: Backport

Use-after-free vulnerability in the mm_answer_pam_free_ctx
function in monitor.c in sshd in OpenSSH before 7.0 on
non-OpenBSD platforms might allow local users to gain
privileges by leveraging control of the sshd uid to send
an unexpectedly early MONITOR_REQ_PAM_FREE_CTX request.

Patch from:
https://github.com/openssh/openssh-portable/commit/5e75f5198769056089fb06c4d738ab0e5abc66f7

set sshpam_ctxt to NULL after free

Avoids use-after-free in monitor when privsep child is compromised.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 monitor.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/monitor.c b/monitor.c
index a6ec396..af63490 100644
--- a/monitor.c
+++ b/monitor.c
@@ -1109,14 +1109,16 @@ mm_answer_pam_respond(int sock, Buffer *m)
 int
 mm_answer_pam_free_ctx(int sock, Buffer *m)
 {
+	int r = sshpam_authok != NULL && sshpam_authok == sshpam_ctxt;
 
 	debug3("%s", __func__);
 	(sshpam_device.free_ctx)(sshpam_ctxt);
+	sshpam_ctxt = sshpam_authok = NULL;
 	buffer_clear(m);
 	mm_request_send(sock, MONITOR_ANS_PAM_FREE_CTX, m);
 	auth_method = "keyboard-interactive";
 	auth_submethod = "pam";
-	return (sshpam_authok == sshpam_ctxt);
+	return r;
 }
 #endif
 
-- 
1.8.5.2.233.g932f7e4

