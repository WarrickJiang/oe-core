From 74069dde362e8d30e67991253a8fe888bc043d38 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Mon, 17 Aug 2015 08:53:19 +0000
Subject: [PATCH 1/2] openssh-CVE-2015-5600

Upstream-Status: Backport

The kbdint_next_device function in auth2-chall.c in sshd in OpenSSH
through 6.9 does not properly restrict the processing of
keyboard-interactive devices within a single connection, which makes
it easier for remote attackers to conduct brute-force attacks or
cause a denial of service (CPU consumption) via a long and
duplicative list in the ssh -oKbdInteractiveDevices option, as
demonstrated by a modified client that provides a different password
for each pam element on this list.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 auth2-chall.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/auth2-chall.c b/auth2-chall.c
index 980250a..84104f2 100644
--- a/auth2-chall.c
+++ b/auth2-chall.c
@@ -82,6 +82,7 @@ struct KbdintAuthctxt
 	void *ctxt;
 	KbdintDevice *device;
 	u_int nreq;
+	u_int devices_done;
 };
 
 #ifdef USE_PAM
@@ -168,11 +169,14 @@ kbdint_next_device(Authctxt *authctxt, KbdintAuthctxt *kbdintctxt)
 		if (len == 0)
 			break;
 		for (i = 0; devices[i]; i++) {
-			if (!auth2_method_allowed(authctxt,
+			if ((kbdintctxt->devices_done & (1 << i)) != 0 ||
+			    !auth2_method_allowed(authctxt,
 			    "keyboard-interactive", devices[i]->name))
 				continue;
-			if (strncmp(kbdintctxt->devices, devices[i]->name, len) == 0)
+			if (strncmp(kbdintctxt->devices, devices[i]->name, len) == 0) {
 				kbdintctxt->device = devices[i];
+				kbdintctxt->devices_done |= 1 << i;
+			}
 		}
 		t = kbdintctxt->devices;
 		kbdintctxt->devices = t[len] ? xstrdup(t+len+1) : NULL;
-- 
1.8.5.2.233.g932f7e4

