From a24110bf8908999956a3c3aa060ab831302f73d5 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Tue, 1 Sep 2015 16:45:20 +0800
Subject: [PATCH 1/2] openssh: CVE-2015-6563

Upstream-status: Backport

The monitor component in sshd in OpenSSH before 7.0 on non-OpenBSD
platforms accepts extraneous username data in
MONITOR_REQ_PAM_INIT_CTX requests, which allows local users to
conduct impersonation attacks by leveraging any SSH login access
in conjunction with control of the sshd uid to send a crafted
MONITOR_REQ_PWNAM request, related to monitor.c and monitor_wrap.c.

Patch from:
https://github.com/openssh/openssh-portable/commit/d4697fe9a28dab7255c60433e4dd23cf7fce8a8b

Don't resend username to PAM; it already has it.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 monitor.c      | 2 --
 monitor_wrap.c | 1 -
 2 files changed, 3 deletions(-)

diff --git a/monitor.c b/monitor.c
index 531c4f9..a6ec396 100644
--- a/monitor.c
+++ b/monitor.c
@@ -1027,9 +1027,7 @@ extern KbdintDevice sshpam_device;
 int
 mm_answer_pam_init_ctx(int sock, Buffer *m)
 {
-
 	debug3("%s", __func__);
-	authctxt->user = buffer_get_string(m, NULL);
 	sshpam_ctxt = (sshpam_device.init_ctx)(authctxt);
 	sshpam_authok = NULL;
 	buffer_clear(m);
diff --git a/monitor_wrap.c b/monitor_wrap.c
index 1a47e41..b2bc8dd 100644
--- a/monitor_wrap.c
+++ b/monitor_wrap.c
@@ -820,7 +820,6 @@ mm_sshpam_init_ctx(Authctxt *authctxt)
 
 	debug3("%s", __func__);
 	buffer_init(&m);
-	buffer_put_cstring(&m, authctxt->user);
 	mm_request_send(pmonitor->m_recvfd, MONITOR_REQ_PAM_INIT_CTX, &m);
 	debug3("%s: waiting for MONITOR_ANS_PAM_INIT_CTX", __func__);
 	mm_request_receive_expect(pmonitor->m_recvfd, MONITOR_ANS_PAM_INIT_CTX, &m);
-- 
1.8.5.2.233.g932f7e4

