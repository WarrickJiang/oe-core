From 4826577b4fc4bfed2f5a23ec17669d198ec8630c Mon Sep 17 00:00:00 2001
From: "markus@openbsd.org" <markus@openbsd.org>
Date: Mon, 10 Oct 2016 19:28:48 +0000
Subject: [PATCH] upstream commit

commit ec165c392ca54317dbe3064a8c200de6531e89ad upstream
git://anongit.mindrot.org/openssh.git

Unregister the KEXINIT handler after message has been
received. Otherwise an unauthenticated peer can repeat the KEXINIT and cause
allocation of up to 128MB -- until the connection is closed. Reported by
shilei-c at 360.cn

Upstream-ID: 43649ae12a27ef94290db16d1a98294588b75c05

Upstream-Status: Backport
CVE: CVE-2016-8858

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 kex.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/kex.c b/kex.c
index 5100c66..4c15b86 100644
--- a/kex.c
+++ b/kex.c
@@ -393,6 +393,7 @@ kex_input_kexinit(int type, u_int32_t seq, void *ctxt)
 	if (kex == NULL)
 		return SSH_ERR_INVALID_ARGUMENT;
 
+	ssh_dispatch_set(ssh, SSH2_MSG_KEXINIT, NULL);
 	ptr = sshpkt_ptr(ssh, &dlen);
 	if ((r = sshbuf_put(kex->peer, ptr, dlen)) != 0)
 		return r;
-- 
2.5.0

