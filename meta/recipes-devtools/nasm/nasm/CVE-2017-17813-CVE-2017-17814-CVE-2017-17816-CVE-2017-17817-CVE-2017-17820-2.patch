From 750048723eb837b663828ff25e872b6054bebb38 Mon Sep 17 00:00:00 2001
From: Cyrill Gorcunov <gorcunov@gmail.com>
Date: Wed, 26 Jul 2017 01:21:16 +0300
Subject: [PATCH] preproc: Free token's text if only it has been modified

https://bugzilla.nasm.us/show_bug.cgi?id=3392414

Signed-off-by: Cyrill Gorcunov <gorcunov@gmail.com>
Signed-off-by: H. Peter Anvin <hpa@zytor.com>
---
 asm/preproc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/asm/preproc.c b/asm/preproc.c
index f6e296b..0d0e104 100644
--- a/asm/preproc.c
+++ b/asm/preproc.c
@@ -1280,8 +1280,8 @@ static char *detoken(Token * tlist, bool expand_locals)
                     t->text = nasm_zalloc(2);
                 } else
                     t->text = nasm_strdup(p);
+		nasm_free(q);
             }
-            nasm_free(q);
         }
 
         /* Expand local macros here and not during preprocessing */
-- 
1.7.9.5

