From 9218e80a80bef72aae029d99d5b78f67452ffaab Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Tue, 27 Jan 2015 15:05:10 +0000
Subject: [PATCH] Report an error for S-records with less than the miniumum size

	* srec.c (srec_scan): Revert last change.  Report an error for
	S-records with less than the miniumum byte count.

Summary of changes:
bfd/srec.c |    15 ++++++++++++++-
1 file changed, 14 insertions(+), 1 deletions(-)

Signed-off-by: Prashant Purohit <prashant.purohit@kpit.com>
Upstream-Status: Backport
Signed-off-by: Yuanjie Huang <Yuanjie.Huang@windriver.com>
---
 bfd/srec.c |   15 ++++++++++++++-
 1 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/bfd/srec.c b/bfd/srec.c
index 38e42ed..4d56b7f 100644
--- a/bfd/srec.c
+++ b/bfd/srec.c
@@ -455,7 +455,7 @@ srec_scan (bfd *abfd)
 	  {
 	    file_ptr pos;
 	    unsigned char hdr[3];
-       unsigned int bytes;
+	    unsigned int bytes, min_bytes;
 	    bfd_vma address;
 	    bfd_byte *data;
 	    unsigned char check_sum;
@@ -478,6 +478,19 @@ srec_scan (bfd *abfd)
 	      }
 
 	    check_sum = bytes = HEX (hdr + 1);
+            min_bytes = 3;
+            if (hdr[0] == '2' || hdr[0] == '8')
+             min_bytes = 4;
+            else if (hdr[0] == '3' || hdr[0] == '7')
+             min_bytes = 5;
+            if (bytes < min_bytes)
+             {
+               (*_bfd_error_handler) (_("%B:%d: byte count %d too small\n"),
+                                      abfd, lineno, bytes);
+               bfd_set_error (bfd_error_bad_value);
+               goto error_return;
+             }
+
 	    if (bytes * 2 > bufsize)
 	      {
 		if (buf != NULL)
-- 
1.7.1

