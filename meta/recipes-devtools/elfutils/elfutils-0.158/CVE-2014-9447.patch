From 6a423b360ccb31292aa03c713a8110bc67a496fd Mon Sep 17 00:00:00 2001
From: Alexander Cherepanov <cherepan@mccme.ru>
Date: Sun, 28 Dec 2014 19:57:19 +0300
Subject: [PATCH 1/1] libelf: Fix dir traversal vuln in ar extraction.

commit 147018e729e7c22eeabf15b82d26e4bf68a0d18e upstream

read_long_names terminates names at the first '/' found but then skips
one character without checking (it's supposed to be '\n'). Hence the
next name could start with any character including '/'. This leads to
a directory traversal vulnerability at the time the contents of the
archive is extracted.

The danger is mitigated by the fact that only one '/' is possible in a
resulting filename and only in the leading position. Hence only files
in the root directory can be written via this vuln and only when ar is
executed as root.

The fix for the vuln is to not skip any characters while looking
for '/'.

Signed-off-by: Alexander Cherepanov <cherepan@mccme.ru>
Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 libelf/ChangeLog   | 5 +++++
 libelf/elf_begin.c | 5 +----
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/libelf/ChangeLog b/libelf/ChangeLog
index 27764db..49993bb 100644
--- a/libelf/ChangeLog
+++ b/libelf/ChangeLog
@@ -1,3 +1,8 @@
+2014-12-28  Alexander Cherepanov  <cherepan@mccme.ru>
+
+	* elf_begin.c (read_long_names): Don't miss '/' right after
+	another '/'. Fixes a dir traversal vuln in ar extraction.
+
 2013-11-08  Mark Wielaard  <mjw@redhat.com>
 
 	* elf32_updatefile.c (elfXX_updatemmap): Only memcpy ehdr when not
diff --git a/libelf/elf_begin.c b/libelf/elf_begin.c
index 0463b24..197cbaf 100644
--- a/libelf/elf_begin.c
+++ b/libelf/elf_begin.c
@@ -744,10 +744,7 @@ read_long_names (Elf *elf)
 	    break;
 
 	  /* NUL-terminate the string.  */
-	  *runp = '\0';
-
-	  /* Skip the NUL byte and the \012.  */
-	  runp += 2;
+	  *runp++ = '\0';
 
 	  /* A sanity check.  Somebody might have generated invalid
 	     archive.  */
-- 
1.8.5.2.233.g932f7e4

