From dcfdde3a193579e624ba772dadfc0757b1003a3e Mon Sep 17 00:00:00 2001
From: Haiqing Bai <Haiqing.Bai@windriver.com>
Date: Thu, 4 Jan 2018 15:11:46 +0800
Subject: [PATCH] Check fname in recv_files sooner.

Author: Jeriko One <jeriko.one@gmx.us>

[make check_filter returns 0 to '.' after the put check_filter ahead]
Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 exclude.c  |  3 +++
 receiver.c | 12 ++++++------
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/exclude.c b/exclude.c
index 0aaa19b..7c353a1 100644
--- a/exclude.c
+++ b/exclude.c
@@ -726,6 +726,9 @@ int check_filter(filter_rule_list *listp, enum logcode code,
 {
 	filter_rule *ent;
 
+	if (name && (name[0] == '.') && (strlen(name) == 1))
+		return 0;
+
 	for (ent = listp->head; ent; ent = ent->next) {
 		if (ignore_perishable && ent->rflags & FILTRULE_PERISHABLE)
 			continue;
diff --git a/receiver.c b/receiver.c
index 4ea4c09..18b044a 100644
--- a/receiver.c
+++ b/receiver.c
@@ -580,6 +580,12 @@ int recv_files(int f_in, int f_out, char *local_name)
 			file = dir_flist->files[cur_flist->parent_ndx];
 		fname = local_name ? local_name : f_name(file, fbuf);
 
+		if (daemon_filter_list.head
+		    && check_filter(&daemon_filter_list, FLOG, fname, 0) < 0) {
+			rprintf(FERROR, "attempt to hack rsync failed.\n");
+			exit_cleanup(RERR_PROTOCOL);
+		}
+
 		if (DEBUG_GTE(RECV, 1))
 			rprintf(FINFO, "recv_files(%s)\n", fname);
 
@@ -651,12 +657,6 @@ int recv_files(int f_in, int f_out, char *local_name)
 
 		cleanup_got_literal = 0;
 
-		if (daemon_filter_list.head
-		    && check_filter(&daemon_filter_list, FLOG, fname, 0) < 0) {
-			rprintf(FERROR, "attempt to hack rsync failed.\n");
-			exit_cleanup(RERR_PROTOCOL);
-		}
-
 		if (read_batch) {
 			int wanted = redoing
 				   ? we_want_redo(ndx)
-- 
1.9.1

