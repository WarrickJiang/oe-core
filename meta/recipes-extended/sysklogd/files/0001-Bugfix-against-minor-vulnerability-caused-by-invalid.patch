From 5b156a903326e7d1403c1750f3721b646eaf551c Mon Sep 17 00:00:00 2001
From: mancha <mancha1@zoho.com>
Date: Sat, 4 Oct 2014 21:34:41 +0200
Subject: [PATCH] Bugfix against minor vulnerability caused by invalid PRI
 value (CVE-2014-3634)

Commit 5b156a903326e7d1403c1750f3721b646eaf551c upstream

Rainer Gerhards, rsyslog project leader, discovered an issue in rsyslogd
where invalid priority values can trigger DoS and potentially RCE.

As his analysis reveals, the cause of the problem identified in rsyslog's
rsyslogd also exists in sysklogd's syslogd (from which rsyslogd was forked)
and stems from the use of a (LOG_FACMASK|LOG_PRIMASK) mask to detect invalid
priority values.

In sysklogd's syslogd, invalid priority values between 192 and 1023 (directly
or arrived at via overflow wraparound) can propagate through code causing
out-of-bounds access to the f_pmask array within the 'filed' structure by up
to 104 bytes past its end. Though most likely insufficient to reach
unallocated memory because there are around 544 bytes past f_pmask in 'filed'
(mod packing and other differences), incorrect access of fields at higher
positions of the 'filed' structure definition can cause unexpected behavior
including message mis-classification, forwarding issues, message loss,
or other.

This patch imposes a restriction on PRI message parts and requires they
be properly-delimited priority value strings that have non-negative
numerical values not exceeding 191. As before, sysklogd's syslogd permits
zero padding to not break compatibility with RFC-non-compliant loggers that
issue PRIs such as <0091>. Messages without well-formed PRI parts get
logged with priority user.notice (13). (c.f. RFC 3164)

Thanks to Rainer Gerhards for the initial report and analysis.

The commit come from git://git.infodrom.org/infodrom/sysklogd

Upstream-Status: Backport

Signed-off-by: Yue Tao <yue.tao@windriver.com>

---
 syslogd.c |   25 +++++++++++++++++++------
 1 file changed, 19 insertions(+), 6 deletions(-)

diff --git a/syslogd.c b/syslogd.c
index 72f609c..185fc03 100644
--- a/syslogd.c
+++ b/syslogd.c
@@ -642,6 +642,8 @@ int funix[MAXFUNIX] = { -1, };
 #define TABLE_ALLPRI    0xFF    /* Value to indicate all priorities in f_pmask */
 #define	LOG_MARK	LOG_MAKEPRI(LOG_NFACILITIES, 0)	/* mark "facility" */
 
+#define MAX_PRI		191	/* Maximum Priority per RFC 3164 */
+
 /*
  * Flags to logmsg().
  */
@@ -1529,23 +1531,34 @@ void printline(hname, msg)
 	register char *p, *q;
 	register unsigned char c;
 	char line[MAXLINE + 1];
-	int pri;
+	unsigned int pri;       	// Valid Priority values are 0-191
+	int prilen=0;			// Track Priority value string len
+	int msglen;
 
 	/* test for special codes */
+	msglen=strlen(msg);
 	pri = DEFUPRI;
 	p = msg;
 
 	if (*p == '<') {
 		pri = 0;
-		while (isdigit(*++p))
-		{
-		   pri = 10 * pri + (*p - '0');
+		while (--msglen > 0 && isdigit((unsigned char)*++p) &&
+					pri <= MAX_PRI) {
+			pri = 10 * pri + (*p - '0');
+			prilen++;
 		}
-		if (*p == '>')
+		if (*p == '>' && prilen)
 			++p;
+		else {
+			pri = DEFUPRI;
+			p = msg;
+		}
 	}
-	if (pri &~ (LOG_FACMASK|LOG_PRIMASK))
+
+	if ((pri &~ (LOG_FACMASK|LOG_PRIMASK)) || (pri > MAX_PRI)) {
 		pri = DEFUPRI;
+		p = msg;
+	}
 
 	memset (line, 0, sizeof(line));
 	q = line;
-- 
1.7.9.5

