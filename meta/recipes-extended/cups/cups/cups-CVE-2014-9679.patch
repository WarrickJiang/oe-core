From c853c715e5d86ad9972534a10f31199934a42e4b Mon Sep 17 00:00:00 2001
From: msweet <msweet@a1ca3aef-8c08-0410-bb20-df032aa958be>
Date: Fri, 30 Jan 2015 15:42:10 +0000
Subject: [PATCH 1/1] Validate cupsBitsPerColor, cupsBitsPerPixel, and
 cupsBytesPerLine to avoid potential buffer overflow with compressed raster
 data (STR #4551)

git-svn-id: svn+ssh://src.apple.com/svn/cups/cups.org/trunk@12452 a1ca3aef-8c08-0410-bb20-df032aa958be
Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 CHANGES.txt     |  2 ++
 filter/raster.c | 10 ++++++++--
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index d05ce49..3950e51 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -3,6 +3,8 @@ CHANGES.txt - 1.7.5 - 2014-07-30
 
 CHANGES IN CUPS V1.7.5
 
+	- Security: cupsRasterReadPixels buffer overflow with invalid page
+	  header and compressed raster data (STR #4551)
 	- Security: Addressed some more situations where symlinked files would
 	  be served by the web interface (STR #4455)
 	- The LPD backend did not work with some versions of glibc (STR #4452)
diff --git a/filter/raster.c b/filter/raster.c
index 8dd76ab..d5d0813 100644
--- a/filter/raster.c
+++ b/filter/raster.c
@@ -3,7 +3,7 @@
  *
  *   Raster file routines for CUPS.
  *
- *   Copyright 2007-2012 by Apple Inc.
+ *   Copyright 2007-2015 by Apple Inc.
  *   Copyright 1997-2006 by Easy Software Products.
  *
  *   This file is part of the CUPS Imaging library.
@@ -281,7 +281,10 @@ cupsRasterReadHeader(
   */
 
   if (!cups_raster_read_header(r))
+  {
+    memset(h, 0, sizeof(cups_page_header_t));
     return (0);
+  }
 
  /*
   * Copy the header to the user-supplied buffer...
@@ -310,7 +313,10 @@ cupsRasterReadHeader2(
   */
 
   if (!cups_raster_read_header(r))
+  {
+    memset(h, 0, sizeof(cups_page_header2_t));
     return (0);
+  }
 
  /*
   * Copy the header to the user-supplied buffer...
@@ -988,7 +994,7 @@ cups_raster_read_header(
 
   cups_raster_update(r);
 
-  return (r->header.cupsBytesPerLine != 0 && r->header.cupsHeight != 0);
+  return (r->header.cupsBytesPerLine != 0 && r->header.cupsHeight != 0 && (r->header.cupsBytesPerLine % r->bpp) == 0);
 }
 
 
-- 
1.8.5.2.233.g932f7e4

